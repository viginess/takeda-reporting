name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  pull-requests: write   # ðŸ‘ˆ allows posting comments back to PRs

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # ensures full history for diffs

      - name: Install GitHub CLI
        run: sudo apt update && sudo apt install gh -y

      - name: Get PR diff
        run: |
          git diff origin/${{ github.event.pull_request.base.ref }} > pr.diff

      - name: Send diff to Claude
        run: |
          RESPONSE=$(curl https://api.anthropic.com/v1/messages \
          -H "Content-Type: application/json" \
          -H "x-api-key: ${{ secrets.ANTHROPIC_API_KEY }}" \
          -H "anthropic-version: 2023-06-01" \
          -d '{
            "model": "claude-3-5-sonnet-20241022",
            "max_tokens": 1200,
            "messages": [
              {
                "role": "user",
                "content": "You are a senior software engineer. Review this pull request diff and provide bugs, risks, and improvements:\n\n'"$(cat pr.diff | sed 's/"/\\"/g')"'" 
              }
            ]
          }')

          echo "$RESPONSE" > review.json

      - name: Post PR comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMENT=$(cat review.json | jq -r '.content[0].text')

          gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
            -f body="$COMMENT"
